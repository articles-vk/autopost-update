<!DOCTYPE html><html lang="ru">	<head>		<meta charset="UTF-8">		<meta name="viewport" content="width=740">		<title>Статья ВКонтакте</title>		<link rel="shortcut icon" href="img/favicon.png" type="image/png">		<link rel="stylesheet" href="css/style.min.css">	</head>	<body>		<header>   <div class="header">      <div class="ava change_theme"></div>      <div class="name_text_block">         <div class="name_text">            <h1>Переписать с нуля и выжить</h1>         </div>         <div class="name_text name_text_2">            <p>Информационная статья ВКонтакте</p>         </div>      </div>   </div></header>		<div class="body__content">			<div class="content">				<!-- начало -->				<h1>Переписать с нуля и выжить</h1>				<p>Разработчик единственного крупного АвтоПоста во ВКонтакте Дима Смирнов рассказывает об истории проекта, трудностях и прочих интересных моментах.</p>				<h2>История проекта</h2>				<p>До АвтоПоста мне не приходилось работать с авторизациями, массовыми запросами и прочими технологиями, которые используются в АвтоПосте.<br>Именно поэтому я горел желанием попробовать что-то новое. Как никто другой я пользовался сервисами автостатуса и даже первого стороннего автопоста, профилей ВК было уже тогда многовато, а вот про свободное время так не скажу.<br>Наблюдая за нескончаемыми блокировками первого урезанного в возможностях автопоста я решил создать свой АвтоПост, который в последствии стал лучшим и единственным на рынке ВКонтакте. На это это указывает функциональность и активность.</p>				<p>Проект был запущен в марте 2020 года и рассчитывался на автоматические действия для пару десятков человек.</p>				<hr>				<h2>v1. Переписать с нуля и выжить</h2>				<p>Постепенно количество пользователей стало расти, потребности увеличивались.</p>				<pre>19 ноября в БД было <b>214</b> токенов и <b>400 активных</b> заданий, а уже через месяц <b>438</b> токенов и <b>550 активных</b> заданий</pre>				<p>В ноябре 2020 поступило много жалоб на работу АвтоПоста. Страшные времена нагрянули.</p>				<blockquote>Как изначально был устроен алгоритм?<br><br>Задания отправляются цепочкой от нулевого пользователя до конечного. Каждые 2 секунды АвтоПост проверяет все задания и отправляет поочередно те, которые уже пора.<br><br>Это значит, что за 2 секунды ему необходимо успеть всё отправить и дождаться ответа от ВК на каждый запрос. 1 запрос в среднем занимает секунду. При таком подходе с работой всего в один поток, на котором ещё висит синхронизация переменных, проверка валидности токенов и непосредственно работа чат-бота в группе идеальная нагрузка составляла до двух заданий в 2 секунды.</blockquote>				<p>Наше преимущество - бесплатное использование АвтоПоста. Нам очень не хотелось от него отказываться, поэтому оставалось единственное решение - переписать код с нуля. Нам было необходимо разделить задачи так, чтобы в цепочке запросов не было больших очередей.</p>				<blockquote>Почему задержки росли на глазах?<br><br>Давайте допустим, что боту нужно отправить 3 запроса за 2 секунды, а он может отправить только 2. Значит третий запрос выполнится на третью секенду работы бота. А на четвертую (2+2) уже будет пора отправить новую партию. Так как третья секунда использована, на 3 задания остаётся только 1 секунда. На следующую цепочку выполнения у нас вовсе время заканчивается, а задания растут до пяти. И тут наступает вечный прирост задержки. Старые задания не успевают отправиться, а новые уже топчуться по ним. Боту хватало минуты работы, чтобы собрать задержку выполнения в сутки.<br><br>Так как всё было на одном потоке, бот отвечал тоже через сутки. Изменения применялись только через двое суток, поскольку когда пришло время ответить на вчерашнее сообщение, на завтра очередь заданий занята.</blockquote>				<p>Работать с заданиями и прочими функциями я научился, но что как решить проблему многопоточности? Вопрос не из простых, по простенькому гайду из интернета это не решить, учиться времени нет, а к тому же JavaScript изначально предназначался для сайтов, поэтому в нём отсутствует базовый необходимый функционал для решения таких задач. Будем искать варианты.</p>				<blockquote>Сторонние модули VK-IO для чат-ботов ВКонтакте на Node JavaScript и как ими воспользоваться?<br><br>				Модуль, который используется мной оказался очень полезен в этой ситуации. В нём реализована авторизация через Callback API, User Long Poll и Bots Long Poll. Этот функционал подобен сессиям ВКонтакте: Вы можете сидеть сразу и с телефона и с ПК и легко управлять этим в настройках.<br><br>То есть если чат-бот запросит авторизацию два раза он создаст два разных потока. И у обоих будет собственная очередь, если у одного будет 100 заданий, а у другого 5, то второй не пострадает из-за первого и продолжит свою работу штатно.<br>Собственно так, в ноябре и работала одна из новых функций предотвращающих пользователей от потери связи с чат-ботом при его блокировке путём работы одновременно в нескольких группах.</blockquote>				<p>Так весь декабрь я работал над новой версией АвтоПоста, чтобы успеть к Новому Году выпустить первое крупное обновление. <b>Всё получилось :)</b></p>				<p><b>Изменения:</b></p>				<ul>					<li>Время проверки заданий увеличено до 5 секунд</li>					<li>У каждого типа задания - свой поток, у чат-бота - свой, а у сиинхронизаций и прочих функций - свой</li>				</ul>				<hr>				<h2>v2. Переписать с нуля и выжить</h2>				<pre>11 мая в БД было <b>516</b> токенов и <b>900 активных</b> (5600 всего) заданий, а через два месяца <b>590</b> токенов и <b>1050 активных</b> (7000) заданий</pre>				<p>В 2021 году активность значительно выросла. Одна из основных причин этого - запуск нового проекта "Автоматизация Bot Gorilla" в январе по просьбам пользователей. Этот проект дублирует структуру АвтоПоста, но отличается тем, что работает не зацикленно, а когда придёт сообщение.<br>Этот проект также испытывал проблемы, но не с нагрузкой, а с распознованием капчи с фотографий. Мы успешно решили эту проблему и теперь являемся также единственным продуктом на рынке ВКонтакте. Несмотря на то, что этот проект уже платный, переплачивать пользователям совсем не приходится. Цена минимальна.</p>				<p>Вторая версия АвтоПоста разрабатывалась на протяжении нескольких месяцев и вовсе не из-за нагрузки, хотя об этом тоже расскажу.</p>				<p>Так как ВКонтакте не разрешает собирать токены чат-ботам наши сообщества постоянно блокировались.<br><br>В январе я заключил договор с ВКонтакте относительно сообществ АвтоПоста и оно работает до сих пор, но угроза остаётся. Так, например, недавно злоумышленники заблокировали наше сообщество с Автоматизацией Bot Gorilla. Мы восстановили его за считанные минуты, а в будущем не исключаем разработку противоблокировочной системы, которая возьмёт на себя автоматизацию пересоздания, настройку и замену сообществ с использованием секретных технологий. Пользователи будут получать новое сообщество в течении нескольких секунд.</p>				<p>Можем с уверенностью заявить, что вторую версию АвтоПоста заблокировать не получится. Всё будет происходить законно.</p>				<blockquote>Как работает новая вторая версия АвтоПоста?<br><br>Наш чат-бот попросит Вас создать своё пустое сообщество и подключить его к АвтоПосту. Ваш чат-бот будет работать как прежде работал АвтоПост.<br><br>Благодаря такому технологическому решению злоумышленники будут блокировать сами себя.</blockquote>				<blockquote>Задания в новой второй версии АвтоПоста<br><br>В новой версии у каждого пользователя своя очередь запросов и даст она знать о себе, только тогда, когда у пользователя будут десятки или сотни активных заданий, которые будут отправляться в одинаковое время.<br><br>Благодаря новому подходу никакие нагрузки определенного пользователя, атаки на чат-бота или прочие помехи не смогут убить всю систему и пользователи не будут незамечать такие действия.</blockquote>				<p>Переписать с нуля весь проект и не добавить каких-нибудь плюшек было бы очень сложно. Держите часть из них:</p>				<ul>					<li>Новый тариф "Premium"</li>					<li>Задания из-за ошибок ВКонтакте отключатся не через 3 ошибки, а через большее количество. В данный момент это 12 ошибок для тарифа "Premium"</li>					<li>Указание рандомного времени отправки заданий (обычное указание времени - минимум, вторичное - максимум). В данный момент бесплатно.</li>					<li>Исправлена синхронизация переменных</li>					<li>Удобная настройка заданий - гора клавиатур и краткие, понятные ответы</li>					<li>Изменения в командах, например, команда "Задания" стала удобнее и компактнее, и никакая длина не остановит показ списка заданий</li>					<li>Теперь можно включить или отключить токен - это даст отличную возможность приостановить все задания на этом токене</li>				</ul>				<hr>				<h2>Свежая статистика</h2>				<pre>Пользователей написало - 1060 (25 повысили тариф, 34 имеют положительный баланс)<br>Заданий - 1100 (7120 всего)<br>Токенов - 600</pre>				<!-- конец -->				<div class="content_exit"></div>			</div>		</div>		<nav>   <div class="nav">      <div class="ava"></div>      <div class="name_text_block l">         <div class="name_text l">            <p>Дизайн сайта "Статья ВКонтакте" разработал <a href="https://vk.com/coder_cm">Дима Смирнов</a></p>         </div>      </div>      <div class="r">         <div class="name_text_block l">            <div class="name_text name_text_2">               <p><a href="https://coder-dima.github.io/vk/terms">Оферта</a></p>            </div>         </div>         <div class="ava-2 r"></div>      </div>   </div></nav>		<script src="js/script.min.js"></script>	</body></html>